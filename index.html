<!DOCTYPE html>
<html lang="fr" data-theme="auto">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D√©butant - Gestion Contrats</title>
  <meta name="theme-color" content="#0b0c10">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root {
      --bg: #0b0c10;
      --card: #12141b;
      --muted: #a9b0c0;
      --text: #eef1f7;
      --accent: #6ee7ff;
      --accent2: #7cffb2;
      --danger: #ff6b6b;
      --warn: #ffd166;
      --border: rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    @media (prefers-color-scheme: light) {
      html[data-theme="auto"] {
        --bg: #f4f6fb;
        --card: #ffffff;
        --muted: #5b6578;
        --text: #0c1220;
        --accent: #0891b2;
        --accent2: #059669;
        --danger: #d64545;
        --warn: #a16b00;
        --border: rgba(12,18,32,.12);
        --shadow: 0 10px 30px rgba(0,0,0,.10);
      }
    }

    html[data-theme="light"] {
      --bg: #f4f6fb;
      --card: #ffffff;
      --muted: #5b6578;
      --text: #0c1220;
      --accent: #0891b2;
      --accent2: #059669;
      --danger: #d64545;
      --warn: #a16b00;
      --border: rgba(12,18,32,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.10);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: var(--sans);
      background: radial-gradient(1000px 600px at 10% 0%, rgba(110,231,255,.12), transparent 60%),
                  radial-gradient(900px 500px at 100% 20%, rgba(124,255,178,.10), transparent 60%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 0;
    }

    html[data-theme="light"] body {
      background: var(--bg);
    }

    /* Header */
    .header {
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent), var(--card);
      border-bottom: 1px solid var(--border);
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
    }

    html[data-theme="light"] .header {
      background: var(--card);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .header h1 {
      font-size: 22px;
      font-weight: 800;
      color: var(--accent);
      margin: 0;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Tabs Navigation */
    .tabs-nav {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      position: sticky;
      top: 68px;
      z-index: 90;
    }

    .tabs-list {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      gap: 4px;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .tabs-list::-webkit-scrollbar { display: none; }

    .tab-btn {
      padding: 14px 20px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .tab-btn:hover {
      color: var(--text);
      background: rgba(255,255,255,.03);
    }

    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Card */
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 30%), var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    html[data-theme="light"] .card {
      background: var(--card);
    }

    .card h2 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text);
    }

    /* Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 768px) {
      .grid-2 { grid-template-columns: 1fr; }
    }

    /* Form */
    .form-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .form-group {
      flex: 1;
      min-width: 200px;
    }

    .form-group.sm {
      flex: 0 0 180px;
      min-width: 180px;
    }

    .form-group.xs {
      flex: 0 0 140px;
      min-width: 140px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input, select, textarea {
      width: 100%;
      padding: 11px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: color-mix(in srgb, var(--card) 70%, var(--bg));
      color: var(--text);
      font-family: var(--sans);
      font-size: 14px;
      transition: all 0.2s;
      outline: none;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(110,231,255,0.1);
    }

    input::placeholder {
      color: color-mix(in srgb, var(--muted) 70%, transparent);
    }

    /* Checkbox row */
    .check-row {
      display: flex;
      gap: 16px;
      padding: 12px;
      border: 1px dashed var(--border);
      border-radius: 10px;
      background: color-mix(in srgb, var(--card) 90%, transparent);
      flex-wrap: wrap;
    }

    .check-row label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
      font-size: 14px;
      color: var(--text);
      cursor: pointer;
    }

    .check-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* Buttons */
    .btn-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    button, .btn {
      padding: 11px 18px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(110,231,255,.12);
      color: var(--text);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: var(--sans);
    }

    button:hover, .btn:hover {
      background: rgba(110,231,255,.18);
      transform: translateY(-1px);
    }

    button:active, .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }

    .btn-primary:hover {
      background: color-mix(in srgb, var(--accent) 85%, #000);
    }

    .btn-danger {
      background: rgba(255,107,107,.15);
      border-color: rgba(255,107,107,.3);
      color: var(--danger);
    }

    .btn-danger:hover {
      background: rgba(255,107,107,.25);
    }

    .btn-ghost {
      background: transparent;
    }

    .btn-sm {
      padding: 8px 12px;
      font-size: 13px;
    }

    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }

    .kpi {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: color-mix(in srgb, var(--card) 90%, transparent);
    }

    .kpi-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .kpi-value {
      font-size: 24px;
      font-weight: 900;
      font-family: var(--mono);
      color: var(--text);
      margin-bottom: 4px;
    }

    .kpi-sub {
      font-size: 11px;
      color: var(--muted);
    }

    /* Stats Bars */
    .stat-bar {
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: color-mix(in srgb, var(--card) 90%, transparent);
      margin-bottom: 10px;
    }

    .stat-bar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .stat-bar-title {
      font-weight: 700;
      font-size: 14px;
      color: var(--text);
    }

    .stat-bar-value {
      font-weight: 800;
      font-size: 16px;
      font-family: var(--mono);
      color: var(--accent);
    }

    .stat-bar-progress {
      height: 8px;
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      overflow: hidden;
    }

    .stat-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 999px;
      transition: width 0.5s;
    }

    /* List Items */
    .list {
      max-height: 500px;
      overflow-y: auto;
    }

    .list-item {
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: color-mix(in srgb, var(--card) 90%, transparent);
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .list-item-content {
      flex: 1;
      min-width: 0;
    }

    .list-item-title {
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 6px;
      word-break: break-word;
    }

    .list-item-meta {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .list-item-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--card) 90%, transparent);
      white-space: nowrap;
    }

    .badge-iag {
      border-color: rgba(110,231,255,.3);
      color: var(--accent);
      background: rgba(110,231,255,.1);
    }

    .badge-plenitude {
      border-color: rgba(124,255,178,.3);
      color: var(--accent2);
      background: rgba(124,255,178,.1);
    }

    .badge-primeo {
      border-color: rgba(255,209,102,.3);
      color: var(--warn);
      background: rgba(255,209,102,.1);
    }

    .amount {
      font-weight: 900;
      font-size: 16px;
      font-family: var(--mono);
      color: var(--accent);
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }

    .toast {
      padding: 14px 18px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: color-mix(in srgb, var(--card) 95%, transparent);
      backdrop-filter: blur(12px);
      color: var(--text);
      box-shadow: var(--shadow);
      font-size: 14px;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .toast.success { border-color: rgba(124,255,178,.3); }
    .toast.error { border-color: rgba(255,107,107,.3); }
    .toast.warning { border-color: rgba(255,209,102,.3); }

    /* Alert */
    .alert {
      padding: 14px 16px;
      border-radius: 10px;
      margin-bottom: 16px;
      font-size: 14px;
      line-height: 1.5;
      display: none;
    }

    .alert.show { display: block; }

    .alert-error {
      background: rgba(255,107,107,.12);
      border: 1px solid rgba(255,107,107,.3);
      color: color-mix(in srgb, var(--text) 95%, transparent);
    }

    .alert-info {
      background: rgba(110,231,255,.12);
      border: 1px solid rgba(110,231,255,.3);
      color: color-mix(in srgb, var(--text) 95%, transparent);
    }

    /* Export Preview */
    .export-preview {
      background: #0c0e14;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 600px;
      overflow-y: auto;
      color: #e0e0e0;
    }

    html[data-theme="light"] .export-preview {
      background: #f8f9fa;
      color: #1a1a1a;
    }

    /* Pills */
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--card) 90%, transparent);
      font-size: 13px;
      color: var(--muted);
    }

    .pill strong {
      color: var(--text);
      font-weight: 800;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }

    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,.1);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255,255,255,.02);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,.12);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,.18);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        align-items: stretch;
      }

      .header-actions {
        justify-content: space-between;
      }

      .form-group {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <h1>üìä R√©mun√©ration Pro</h1>
      <div class="header-actions">
        <div class="pill">
          <span>Date</span>
          <strong id="currentDate">--</strong>
        </div>
        <select id="themeToggle" class="btn-sm">
          <option value="auto">üåì Auto</option>
          <option value="dark">üåô Sombre</option>
          <option value="light">‚òÄÔ∏è Clair</option>
        </select>
      </div>
    </div>
  </header>

  <!-- Tabs Navigation -->
  <nav class="tabs-nav">
    <div class="tabs-list">
      <button class="tab-btn active" data-tab="contrats">üìù Contrats</button>
      <button class="tab-btn" data-tab="jour">üìÖ Jour</button>
      <button class="tab-btn" data-tab="semaine">üìä Semaine</button>
      <button class="tab-btn" data-tab="mois">üìà Mois</button>
      <button class="tab-btn" data-tab="stats">üìâ Statistiques</button>
      <button class="tab-btn" data-tab="export">üíæ Export</button>
    </div>
  </nav>

  <!-- Main Container -->
  <main class="container">
    <!-- Tab Contrats -->
    <div id="tab-contrats" class="tab-content active">
      <div class="card">
        <h2 id="formTitle">‚ûï Ajouter un contrat</h2>
        <form id="addContractForm">
          <div class="form-row">
            <div class="form-group sm">
              <label for="contractDate">Date *</label>
              <input type="date" id="contractDate" required>
            </div>
            <div class="form-group">
              <label for="contractName">Nom Client *</label>
              <input type="text" id="contractName" placeholder="Ex: DUPONT" required maxlength="80">
            </div>
            <div class="form-group">
              <label for="contractRef">R√©f√©rence *</label>
              <input type="text" id="contractRef" placeholder="Ex: A-12345678, VTCO12345678, 406XXXXX" required maxlength="50">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group sm">
              <label for="contractProvider">Fournisseur *</label>
              <select id="contractProvider" required>
                <option value="">-- Choisir --</option>
                <option value="PLENITUDE">Plenitude</option>
                <option value="PRIMEO">Primeo</option>
              </select>
            </div>
            <div class="form-group sm">
              <label for="contractType">Type *</label>
              <select id="contractType" required>
                <option value="">-- Choisir --</option>
              </select>
            </div>
            <div class="form-group sm" id="powerGroup" style="display:none;">
              <label for="contractPower">Puissance *</label>
              <select id="contractPower"></select>
            </div>
            <div class="form-group sm" id="consoGroup" style="display:none;">
              <label for="contractConso">Consommation *</label>
              <select id="contractConso"></select>
            </div>
          </div>

          <div id="optionsGroup" style="display:none;">
            <div class="check-row">
              <label>
                <input type="checkbox" id="contractAxa">
                Assistance AXA (+7‚Ç¨)
              </label>
              <label>
                <input type="checkbox" id="contractDigi">
                Digitalisation (+2‚Ç¨)
              </label>
            </div>
          </div>

          <div class="form-row" id="iagGroup" style="display:none;">
            <div class="form-group sm">
              <label for="contractIagType">Type IAG</label>
              <select id="contractIagType">
                <option value="">Aucun</option>
                <option value="PJI">PJI</option>
                <option value="ELA">ELA</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="contractIagRef">R√©f√©rence IAG</label>
            <input type="text" id="contractIagRef" placeholder="Ex: 406XXXXX / A-12345678" maxlength="50">
          </div>

          <div class="alert alert-error" id="formError"></div>

          <div class="btn-row">
            <button type="submit" class="btn-primary" id="btnSubmitContract">‚ûï Ajouter le contrat</button>
            <button type="button" class="btn-ghost" id="btnClearForm">üîÑ R√©initialiser</button>
            <button type="button" class="btn-danger" id="btnCancelEdit" style="display:none;">‚úñ Annuler √©dition</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>üìã Liste des contrats</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="searchName">üîç Recherche (nom ou r√©f√©rence)</label>
            <input type="text" id="searchName" placeholder="Rechercher...">
          </div>
          <div class="form-group sm">
            <label for="filterProvider">Fournisseur</label>
            <select id="filterProvider">
              <option value="">Tous</option>
              <option value="PLENITUDE">Plenitude</option>
              <option value="PRIMEO">Primeo</option>
            </select>
          </div>
          <div class="form-group sm">
            <label for="filterDate">Date</label>
            <input type="date" id="filterDate">
          </div>
        </div>
        <div id="contractsList" class="list"></div>
        <div id="contractsEmpty" class="empty-state" style="display:none;">
          <div class="empty-state-icon">üìã</div>
          <p>Aucun contrat trouv√©</p>
        </div>
      </div>
    </div>

    <!-- Tab Jour -->
    <div id="tab-jour" class="tab-content">
      <div class="card">
        <h2>üìÖ R√©sum√© du jour</h2>
        <div class="form-row">
          <div class="form-group sm">
            <label for="dayDate">Date</label>
            <input type="date" id="dayDate">
          </div>
        </div>
        <div id="dayKpis" class="kpi-grid"></div>
        <div id="dayNote" style="margin-top:16px; font-size:13px; color:var(--muted);"></div>
      </div>

      <div class="card">
        <h2>üìù Contrats du jour</h2>
        <div id="dayContractsList" class="list"></div>
        <div id="dayContractsEmpty" class="empty-state" style="display:none;">
          <div class="empty-state-icon">üìù</div>
          <p>Aucun contrat pour ce jour</p>
        </div>
      </div>
    </div>

    <!-- Tab Semaine -->
    <div id="tab-semaine" class="tab-content">
      <div class="card">
        <h2>üìä R√©sum√© de la semaine</h2>
        <div class="form-row">
          <div class="form-group sm">
            <label for="weekDate">S√©lectionner une date</label>
            <input type="date" id="weekDate">
          </div>
          <div class="form-group">
            <label>P√©riode</label>
            <div class="pill" style="width:100%; justify-content:space-between;">
              <span id="weekRange">--</span>
              <strong id="weekNumber">--</strong>
            </div>
          </div>
        </div>
        <div id="weekKpis" class="kpi-grid"></div>
      </div>

      <div class="card">
        <h2>üìä R√©partition par type</h2>
        <div id="weekStats"></div>
      </div>

      <div class="card">
        <h2>üìù Contrats de la semaine</h2>
        <div id="weekContractsList" class="list"></div>
        <div id="weekContractsEmpty" class="empty-state" style="display:none;">
          <div class="empty-state-icon">üìù</div>
          <p>Aucun contrat pour cette semaine</p>
        </div>
      </div>
    </div>

    <!-- Tab Mois -->
    <div id="tab-mois" class="tab-content">
      <div class="card">
        <h2>üìà R√©sum√© du mois</h2>
        <div class="form-row">
          <div class="form-group sm">
            <label for="monthDate">S√©lectionner une date</label>
            <input type="date" id="monthDate">
          </div>
          <div class="form-group">
            <label>Mois</label>
            <div class="pill" style="width:100%; justify-content:space-between;">
              <span id="monthLabel">--</span>
            </div>
          </div>
        </div>
        <div id="monthKpis" class="kpi-grid"></div>
      </div>

      <div class="card">
        <h2>üìä R√©partition par type</h2>
        <div id="monthStats"></div>
      </div>

      <div class="card">
        <h2>üéØ Objectif mensuel</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="monthlyGoal">Objectif (nombre de contrats)</label>
            <input type="number" id="monthlyGoal" min="0" placeholder="Ex: 120">
          </div>
        </div>
        <div id="goalProgress"></div>
      </div>
    </div>

    <!-- Tab Stats -->
    <div id="tab-stats" class="tab-content">
      <div class="card">
        <h2>üìâ Statistiques globales</h2>
        <div id="globalKpis" class="kpi-grid"></div>
      </div>

      <div class="card">
        <h2>üèÜ Records</h2>
        <div id="recordsKpis" class="kpi-grid"></div>
      </div>

      <div class="card">
        <h2>üìä R√©partition globale par type</h2>
        <div id="globalStats"></div>
      </div>
    </div>

    <!-- Tab Export -->
    <div id="tab-export" class="tab-content">
      <div class="card">
        <h2>üìÑ Export texte Semaine</h2>
        <div class="form-row">
          <div class="form-group sm">
            <label for="exportWeekDate">Date semaine</label>
            <input type="date" id="exportWeekDate">
          </div>
        </div>
        <div class="btn-row">
          <button type="button" id="btnGenerateWeek" class="btn-primary">üìÑ G√©n√©rer export semaine</button>
          <button type="button" id="btnCopyWeek" class="btn-ghost">üìã Copier</button>
          <button type="button" id="btnGenerateWeekCompact" class="btn-ghost">üßæ R√©cap compact</button>
        </div>
        <div id="weekExportPreview" class="export-preview" style="margin-top:16px;"></div>
      </div>

      <div class="card">
        <h2>üìÑ Export texte Mois</h2>
        <div class="form-row">
          <div class="form-group sm">
            <label for="exportMonthDate">Date mois</label>
            <input type="date" id="exportMonthDate">
          </div>
        </div>
        <div class="btn-row">
          <button type="button" id="btnGenerateMonth" class="btn-primary">üìÑ G√©n√©rer export mois</button>
          <button type="button" id="btnCopyMonth" class="btn-ghost">üìã Copier</button>
          <button type="button" id="btnGenerateMonthCompact" class="btn-ghost">üßæ R√©cap compact</button>
        </div>
        <div id="monthExportPreview" class="export-preview" style="margin-top:16px;"></div>
      </div>

      <div class="card">
        <h2>üíæ Sauvegarde & Restauration</h2>
        <div class="btn-row">
          <button type="button" id="btnExportJSON" class="btn-primary">üíæ Exporter JSON</button>
          <button type="button" id="btnExportCSV" class="btn-primary">üìä Exporter CSV</button>
          <button type="button" id="btnImportJSON" class="btn-ghost">üì• Importer JSON</button>
          <input type="file" id="importFile" accept=".json" style="display:none;">
        </div>
        <div class="btn-row" style="margin-top:16px;">
          <button type="button" id="btnClearAll" class="btn-danger">üóëÔ∏è Tout effacer</button>
        </div>
        <p style="margin-top:16px; font-size:13px; color:var(--muted);">
          üí° Conseil : Exportez r√©guli√®rement vos donn√©es en JSON pour √©viter toute perte.
        </p>
      </div>
    </div>
  </main>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    (function() {
      'use strict';

      // ========== Configuration ==========
      const DB_NAME = 'remunerationProDB';
      const DB_VERSION = 3;
      const STORE_NAME = 'contracts';
      const STORAGE_KEYS = {
        theme: 'remuneration_theme',
        goal: 'remuneration_monthly_goal',
        lastBackup: 'remuneration_last_backup'
      };

      // Contract types configuration
      const PROVIDERS = ['PLENITUDE', 'PRIMEO'];
      
      const CONTRACT_TYPES = {
        PLENITUDE: {
          ENERGY: [
            { value: 'ELEC_3', label: '√âlectricit√© 3 kVA', requiresPower: false, requiresConso: false },
            { value: 'ELEC_6', label: '√âlectricit√© 6 kVA', requiresPower: false, requiresConso: false },
            { value: 'ELEC_9', label: '√âlectricit√© 9 kVA', requiresPower: false, requiresConso: false },
            { value: 'ELEC_12', label: '√âlectricit√© 12 kVA', requiresPower: false, requiresConso: false },
            { value: 'DUAL', label: 'Dual √ânergie', requiresPower: true, requiresConso: true }
          ],
          IAG: [
            { value: 'IAG_PJI', label: 'IAG - PJI', requiresPower: false, requiresConso: false },
            { value: 'IAG_ELA', label: 'IAG - ELA', requiresPower: false, requiresConso: false }
          ]
        },
        PRIMEO: {
          ENERGY: [
            { value: 'PRIMEO_ELEC_6', label: 'Primeo √âlectricit√© 6 kVA', requiresPower: false, requiresConso: false },
            { value: 'PRIMEO_ELEC_9', label: 'Primeo √âlectricit√© 9 kVA', requiresPower: false, requiresConso: false },
            { value: 'PRIMEO_ELEC_12', label: 'Primeo √âlectricit√© 12 kVA', requiresPower: false, requiresConso: false }
          ],
          IAG: []
        }
      };

      const DUAL_POWER = ['3', '6', '9', '12'];
      const DUAL_CONSO = ['1-6', '6-13', '13+'];

      // Tarif calculation
      const TARIFS = {
        ELEC_3: 2,
        ELEC_6: 7,
        ELEC_9: 12,
        ELEC_12: 17,
        PRIMEO_ELEC_6: 10,
        PRIMEO_ELEC_9: 15,
        PRIMEO_ELEC_12: 20,
        AXA: 7,
        DIGI: 2
      };

      const DUAL_TARIFS = {
        '3|1-6': 4, '3|6-13': 5, '3|13+': 14,
        '6|1-6': 9, '6|6-13': 14, '6|13+': 19,
        '9|1-6': 14, '9|6-13': 19, '9|13+': 24,
        '12|1-6': 19, '12|6-13': 24, '12|13+': 29
      };

      function getIAGTarif(nbIAG) {
        if (nbIAG <= 0) return 0;
        if (nbIAG <= 10) return 5;
        if (nbIAG <= 20) return 7.5;
        if (nbIAG <= 30) return 10;
        if (nbIAG <= 40) return 15;
        if (nbIAG <= 54) return 17.5;
        return 20;
      }

      // ========== State ==========
      let contracts = [];
      let currentTab = 'contrats';

      // Edit state
      let editingId = null;

      // ========== DOM Elements ==========
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => document.querySelectorAll(sel);

      // Header
      const currentDateEl = $('#currentDate');
      const themeToggle = $('#themeToggle');

      // Tabs
      const tabBtns = $$('.tab-btn');
      const tabContents = $$('.tab-content');

      // Form
      const formTitle = $('#formTitle');
      const btnSubmitContract = $('#btnSubmitContract');
      const btnCancelEdit = $('#btnCancelEdit');

      const addContractForm = $('#addContractForm');
      const contractDate = $('#contractDate');
      const contractName = $('#contractName');
      const contractRef = $('#contractRef');
      const contractProvider = $('#contractProvider');
      const contractType = $('#contractType');
      const contractPower = $('#contractPower');
      const contractConso = $('#contractConso');
      const contractAxa = $('#contractAxa');
      const contractDigi = $('#contractDigi');
      const contractIagType = $('#contractIagType');
      const formError = $('#formError');
      const btnClearForm = $('#btnClearForm');
      const contractIagRef = $('#contractIagRef');

      const powerGroup = $('#powerGroup');
      const consoGroup = $('#consoGroup');
      const optionsGroup = $('#optionsGroup');
      const iagGroup = $('#iagGroup');

      // Filters
      const searchName = $('#searchName');
      const filterProvider = $('#filterProvider');
      const filterDate = $('#filterDate');

      // Lists
      const contractsList = $('#contractsList');
      const contractsEmpty = $('#contractsEmpty');

      // Day
      const dayDate = $('#dayDate');
      const dayKpis = $('#dayKpis');
      const dayNote = $('#dayNote');
      const dayContractsList = $('#dayContractsList');
      const dayContractsEmpty = $('#dayContractsEmpty');

      // Week
      const weekDate = $('#weekDate');
      const weekRange = $('#weekRange');
      const weekNumber = $('#weekNumber');
      const weekKpis = $('#weekKpis');
      const weekStats = $('#weekStats');
      const weekContractsList = $('#weekContractsList');
      const weekContractsEmpty = $('#weekContractsEmpty');

      // Month
      const monthDate = $('#monthDate');
      const monthLabel = $('#monthLabel');
      const monthKpis = $('#monthKpis');
      const monthStats = $('#monthStats');
      const monthlyGoal = $('#monthlyGoal');
      const goalProgress = $('#goalProgress');

      // Stats
      const globalKpis = $('#globalKpis');
      const recordsKpis = $('#recordsKpis');
      const globalStats = $('#globalStats');

      // Export
      const exportWeekDate = $('#exportWeekDate');
      const exportMonthDate = $('#exportMonthDate');
      const btnGenerateWeek = $('#btnGenerateWeek');
      const btnGenerateMonth = $('#btnGenerateMonth');
      const btnCopyWeek = $('#btnCopyWeek');
      const btnCopyMonth = $('#btnCopyMonth');
      const btnGenerateWeekCompact = $('#btnGenerateWeekCompact');
      const btnGenerateMonthCompact = $('#btnGenerateMonthCompact');
      const weekExportPreview = $('#weekExportPreview');
      const monthExportPreview = $('#monthExportPreview');
      const btnExportJSON = $('#btnExportJSON');
      const btnExportCSV = $('#btnExportCSV');
      const btnImportJSON = $('#btnImportJSON');
      const importFile = $('#importFile');
      const btnClearAll = $('#btnClearAll');

      // Toast
      const toastContainer = $('#toastContainer');

      // ========== Utilities ==========
      function todayStr() {
        const d = new Date();
        return d.toISOString().slice(0, 10);
      }

      function formatDate(dateStr) {
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}/${y}`;
      }

      function formatEuro(amount) {
        return amount.toFixed(2).replace('.', ',') + ' ‚Ç¨';
      }

      function getWeekNumber(d) {
        const target = new Date(d.valueOf());
        const dayNr = (d.getDay() + 6) % 7;
        target.setDate(target.getDate() - dayNr + 3);
        const firstThursday = target.valueOf();
        target.setMonth(0, 1);
        if (target.getDay() !== 4) {
          target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
        }
        return 1 + Math.ceil((firstThursday - target) / 604800000);
      }

      function getWeekRange(dateStr) {
        const d = new Date(dateStr + 'T00:00:00');
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(d.setDate(diff));
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        return {
          start: monday.toISOString().slice(0, 10),
          end: sunday.toISOString().slice(0, 10),
          week: getWeekNumber(monday)
        };
      }

      function getMonthLabel(dateStr) {
        const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                        'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
        const [y, m] = dateStr.split('-');
        return `${months[parseInt(m) - 1]} ${y}`;
      }

      function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      function showError(msg) {
        formError.textContent = msg;
        formError.classList.add('show');
      }

      function clearError() {
        formError.textContent = '';
        formError.classList.remove('show');
      }

      function sanitizeContracts(raw) {
        if (!Array.isArray(raw)) return [];
        return raw.map((c) => {
          const out = { ...c };
          if (out.reference === undefined && out.ref !== undefined) out.reference = out.ref;
          if (out.digitalisation === undefined && out.digi !== undefined) out.digitalisation = !!out.digi;
          if (out.axa === undefined && out.AXA !== undefined) out.axa = !!out.AXA;
          if (!out.id) out.id = Date.now() + '_' + Math.random().toString(36).slice(2);
          if (!out.date) out.date = todayStr();
          if (!out.name) out.name = 'SANS_NOM';
          if (!out.provider) out.provider = 'PLENITUDE';
          if (!out.type) out.type = 'ELEC_6';
          if (String(out.type).startsWith('IAG_')) out.provider = 'PLENITUDE';
          if (out.type !== 'DUAL') { out.power = null; out.conso = null; }
          return out;
        });
      }

      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          showToast('Copi√© dans le presse-papier', 'success');
        } catch {
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
          showToast('Copi√© dans le presse-papier', 'success');
        }
      }

      // ========== IndexedDB ==========
      function openDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          
          req.onupgradeneeded = (e) => {
            const db = e.target.result;
            let store;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
              store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            } else {
              store = req.transaction.objectStore(STORE_NAME);
            }
            if (!store.indexNames.contains('date')) store.createIndex('date', 'date', { unique: false });
            if (!store.indexNames.contains('provider')) store.createIndex('provider', 'provider', { unique: false });
            if (!store.indexNames.contains('type')) store.createIndex('type', 'type', { unique: false });
            if (!store.indexNames.contains('reference')) store.createIndex('reference', 'reference', { unique: false });
          };

          req.onsuccess = (e) => resolve(e.target.result);
          req.onerror = (e) => reject(e.target.error);
        });
      }

      async function loadContracts() {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_NAME, 'readonly');
          const store = tx.objectStore(STORE_NAME);
          const req = store.getAll();
          req.onsuccess = () => resolve(req.result || []);
          req.onerror = () => reject(req.error);
        });
      }

      async function saveContract(contract) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_NAME, 'readwrite');
          const store = tx.objectStore(STORE_NAME);
          const req = store.put(contract);
          req.onsuccess = () => resolve();
          req.onerror = () => reject(req.error);
        });
      }

      async function bulkReplaceContracts(newContracts) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_NAME, 'readwrite');
          const store = tx.objectStore(STORE_NAME);
          store.clear();
          newContracts.forEach(c => store.put(c));
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
      }

      async function deleteContract(id) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_NAME, 'readwrite');
          const store = tx.objectStore(STORE_NAME);
          const req = store.delete(id);
          req.onsuccess = () => resolve();
          req.onerror = () => reject(req.error);
        });
      }

      async function clearAllContracts() {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_NAME, 'readwrite');
          const store = tx.objectStore(STORE_NAME);
          const req = store.clear();
          req.onsuccess = () => resolve();
          req.onerror = () => reject(req.error);
        });
      }

      // ========== Business Logic ==========
      function calculateAmount(contract) {
        let amount = 0;
        if (String(contract.type).startsWith('IAG_')) return 0;

        if (String(contract.type).startsWith('PRIMEO_')) {
          amount = TARIFS[contract.type] || 0;
        } else if (contract.type === 'DUAL') {
          const key = `${contract.power}|${contract.conso}`;
          amount = DUAL_TARIFS[key] || 0;
        } else {
          amount = TARIFS[contract.type] || 0;
        }

        if (contract.axa) amount += TARIFS.AXA;
        if (contract.digitalisation) amount += TARIFS.DIGI;
        return amount;
      }

      function computeStats(contractsSubset) {
        const stats = {
          total: contractsSubset.length,
          energy: 0,
          iag: 0,
          plenitude: 0,
          primeo: 0,
          byType: {},
          energyAmount: 0,
          iagAmount: 0,
          totalAmount: 0
        };

        contractsSubset.forEach(c => {
          const hasIag = String(c.type).startsWith('IAG_') || !!c.iagType;
          if (hasIag) stats.iag++;
          if (!String(c.type).startsWith('IAG_')) stats.energy++;

          if (c.provider === 'PLENITUDE') stats.plenitude++;
          if (c.provider === 'PRIMEO') stats.primeo++;

          const typeKey = c.type + (c.type === 'DUAL' ? `_${c.power}_${c.conso}` : '');
          stats.byType[typeKey] = (stats.byType[typeKey] || 0) + 1;

          stats.energyAmount += calculateAmount(c);
        });

        const iagTarif = getIAGTarif(stats.iag);
        stats.iagAmount = stats.iag * iagTarif;
        stats.totalAmount = stats.energyAmount + stats.iagAmount;
        return stats;
      }

      function contractTypeLabel(c) {
        if (String(c.type).startsWith('IAG_')) return `IAG ${String(c.type).split('_')[1]}`;
        if (c.type === 'DUAL') return `Dual ${c.power}/${c.conso}`;
        if (String(c.type).startsWith('PRIMEO_')) return c.type.replace(/PRIMEO_/, 'Primeo ').replace(/_/g, ' ');
        return String(c.type).replace(/_/g, ' ');
      }

      function filterContracts(list, filters) {
        return list.filter(c => {
          if (filters.search) {
            const search = filters.search.toLowerCase();
            const name = (c.name || '').toLowerCase();
            const ref = (c.reference || '').toLowerCase();
            const iagRef = (c.iagReference || '').toLowerCase();
            if (!name.includes(search) && !ref.includes(search) && !iagRef.includes(search)) return false;
          }
          if (filters.provider && c.provider !== filters.provider) return false;
          if (filters.date && c.date !== filters.date) return false;
          return true;
        });
      }

      function getContractsByPeriod(list, startDate, endDate) {
        return list.filter(c => c.date >= startDate && c.date <= endDate);
      }

      function groupByDate(list) {
        const map = {};
        list.forEach(c => {
          map[c.date] = map[c.date] || [];
          map[c.date].push(c);
        });
        return map;
      }

      function buildWeekExportText(dateStr) {
        const week = getWeekRange(dateStr);
        const weekContracts = getContractsByPeriod(contracts, week.start, week.end);
        const stats = computeStats(weekContracts);

        const lines = [];
        lines.push(`Semaine ${week.week} (${formatDate(week.start)} ‚Üí ${formatDate(week.end)})`);
        lines.push(`Total contrats: ${stats.total} | Energie: ${stats.energy} | IAG: ${stats.iag}`);
        lines.push(`Plenitude: ${stats.plenitude} | Primeo: ${stats.primeo}`);
        lines.push(`‚Ç¨ Energie: ${formatEuro(stats.energyAmount)} | ‚Ç¨ IAG: ${formatEuro(stats.iagAmount)} | ‚Ç¨ Total: ${formatEuro(stats.totalAmount)}`);
        lines.push('');
        lines.push('D√©tail contrats:');

        if (weekContracts.length === 0) {
          lines.push('- Aucun contrat');
        } else {
          weekContracts
            .slice()
            .sort((a,b)=>a.date.localeCompare(b.date))
            .forEach(c => {
              const opts = [];
              if (c.axa) opts.push('AXA');
              if (c.digitalisation) opts.push('Digi');
              if (c.iagType) opts.push(`IAG ${c.iagType}${c.iagReference ? ` (${c.iagReference})` : ''}`);
              const optTxt = opts.length ? ` | ${opts.join(' / ')}` : '';
              lines.push(`- ${formatDate(c.date)} | ${c.name} | ${c.reference} | ${contractTypeLabel(c)} | ${c.provider} | ${formatEuro(calculateAmount(c))}${optTxt}`);
            });
        }

        return lines.join('\n');
      }

      function buildWeekExportCompactText(dateStr) {
        const week = getWeekRange(dateStr);
        const weekContracts = getContractsByPeriod(contracts, week.start, week.end);
        const byDate = groupByDate(weekContracts);

        const lines = [];
        lines.push(`R√©cap Semaine ${week.week} (${formatDate(week.start)} ‚Üí ${formatDate(week.end)})`);
        lines.push('');

        const dates = Object.keys(byDate).sort();
        if (dates.length === 0) {
          lines.push('- Aucun contrat');
          return lines.join('\n');
        }

        dates.forEach(ds => {
          const st = computeStats(byDate[ds]);
          lines.push(`${formatDate(ds)} : ${st.total} contrats (E:${st.energy} / I:${st.iag}) | ‚Ç¨E ${formatEuro(st.energyAmount)} | ‚Ç¨I ${formatEuro(st.iagAmount)} | ‚Ç¨T ${formatEuro(st.totalAmount)}`);
        });

        const total = computeStats(weekContracts);
        lines.push('');
        lines.push(`TOTAL : ${total.total} contrats | ‚Ç¨E ${formatEuro(total.energyAmount)} | ‚Ç¨I ${formatEuro(total.iagAmount)} | ‚Ç¨T ${formatEuro(total.totalAmount)}`);
        return lines.join('\n');
      }

      function buildMonthExportText(dateStr) {
        const monthStr = dateStr.slice(0,7);
        const monthContracts = contracts.filter(c => c.date.startsWith(monthStr));
        const stats = computeStats(monthContracts);

        const lines = [];
        lines.push(`Mois: ${getMonthLabel(dateStr)}`);
        lines.push(`Total contrats: ${stats.total} | Energie: ${stats.energy} | IAG: ${stats.iag} (${stats.total>0?((stats.iag/stats.total)*100).toFixed(1):0}%)`);
        lines.push(`Plenitude: ${stats.plenitude} | Primeo: ${stats.primeo}`);
        lines.push(`Tarif IAG: ${formatEuro(getIAGTarif(stats.iag))} par IAG`);
        lines.push(`‚Ç¨ Energie: ${formatEuro(stats.energyAmount)} | ‚Ç¨ IAG: ${formatEuro(stats.iagAmount)} | ‚Ç¨ Total: ${formatEuro(stats.totalAmount)}`);
        lines.push('');
        lines.push('D√©tail contrats:');

        if (monthContracts.length === 0) {
          lines.push('- Aucun contrat');
        } else {
          monthContracts
            .slice()
            .sort((a,b)=>a.date.localeCompare(b.date))
            .forEach(c => {
              const opts = [];
              if (c.axa) opts.push('AXA');
              if (c.digitalisation) opts.push('Digi');
              if (c.iagType) opts.push(`IAG ${c.iagType}${c.iagReference ? ` (${c.iagReference})` : ''}`);
              const optTxt = opts.length ? ` | ${opts.join(' / ')}` : '';
              lines.push(`- ${formatDate(c.date)} | ${c.name} | ${c.reference} | ${contractTypeLabel(c)} | ${c.provider} | ${formatEuro(calculateAmount(c))}${optTxt}`);
            });
        }

        return lines.join('\n');
      }

      function buildMonthExportCompactText(dateStr) {
        const monthStr = dateStr.slice(0,7);
        const monthContracts = contracts.filter(c => c.date.startsWith(monthStr));
        const stats = computeStats(monthContracts);

        const lines = [];
        lines.push(`R√©cap Mois: ${getMonthLabel(dateStr)}`);
        lines.push(`Total: ${stats.total} | ‚Ç¨E ${formatEuro(stats.energyAmount)} | ‚Ç¨I ${formatEuro(stats.iagAmount)} | ‚Ç¨T ${formatEuro(stats.totalAmount)}`);
        lines.push('');

        const byType = Object.entries(stats.byType).sort((a,b)=>b[1]-a[1]);
        if (byType.length === 0) {
          lines.push('- Aucun contrat');
          return lines.join('\n');
        }

        byType.forEach(([typeKey, count]) => {
          const pct = stats.total > 0 ? (count / stats.total * 100) : 0;
          lines.push(`${typeKey.replace(/_/g,' ')} : ${count} (${pct.toFixed(1)}%)`);
        });

        return lines.join('\n');
      }

      function toCSV(rows) {
        const esc = (v) => {
          const s = String(v ?? '');
          if (/[";\n\r]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
          return s;
        };
        return rows.map(r => r.map(esc).join(';')).join('\n');
      }

      function normalizeReference(ref) {
        return String(ref || '').trim().toLowerCase();
      }

      function isDuplicateReference(reference, exceptId = null) {
        const refNorm = normalizeReference(reference);
        if (!refNorm) return false;
        return contracts.some(c => normalizeReference(c.reference) === refNorm && c.id !== exceptId);
      }

      function setEditMode(id) {
        editingId = id;
        formTitle.textContent = '‚úèÔ∏è Modifier un contrat';
        btnSubmitContract.textContent = 'üíæ Enregistrer modifications';
        btnCancelEdit.style.display = '';
      }

      function clearEditMode() {
        editingId = null;
        formTitle.textContent = '‚ûï Ajouter un contrat';
        btnSubmitContract.textContent = '‚ûï Ajouter le contrat';
        btnCancelEdit.style.display = 'none';
      }

      function fillFormFromContract(c) {
        contractDate.value = c.date;
        contractName.value = c.name || '';
        contractRef.value = c.reference || '';

        contractProvider.value = c.provider || '';
        contractType.dataset.provider = '';
        updateFormFields();

        contractType.value = c.type || '';
        updateFormFields();

        contractAxa.checked = !!c.axa;
        contractDigi.checked = !!c.digitalisation;

        if (c.type === 'DUAL') {
          contractPower.value = c.power || DUAL_POWER[0];
          contractConso.value = c.conso || DUAL_CONSO[0];
        }

        contractIagType.value = c.iagType || '';
        contractIagRef.value = c.iagReference || '';
      }

      // ========== Form Management ==========
      function populateTypeOptions(provider) {
        contractType.innerHTML = '<option value="">-- Choisir --</option>';

        const types = CONTRACT_TYPES[provider];
        if (!types) return;

        const energyGroup = document.createElement('optgroup');
        energyGroup.label = '√ânergie';
        types.ENERGY.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.value;
          opt.textContent = t.label;
          energyGroup.appendChild(opt);
        });
        contractType.appendChild(energyGroup);

        if (types.IAG && types.IAG.length) {
          const iagOptGroup = document.createElement('optgroup');
          iagOptGroup.label = 'IAG';
          types.IAG.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.value;
            opt.textContent = t.label;
            iagOptGroup.appendChild(opt);
          });
          contractType.appendChild(iagOptGroup);
        }
      }

      function updateFormFields() {
        const provider = contractProvider.value;
        const type = contractType.value;

        powerGroup.style.display = 'none';
        consoGroup.style.display = 'none';
        optionsGroup.style.display = 'none';
        iagGroup.style.display = 'none';

        if (!provider) {
          populateTypeOptions('');
          return;
        }

        if (contractType.dataset.provider !== provider) {
          populateTypeOptions(provider);
          contractType.dataset.provider = provider;
        }

        if (!type) return;

        if (type === 'DUAL') {
          powerGroup.style.display = '';
          consoGroup.style.display = '';
          optionsGroup.style.display = '';

          contractPower.innerHTML = DUAL_POWER.map(p => `<option value="${p}">${p} kVA</option>`).join('');
          contractConso.innerHTML = DUAL_CONSO.map(c => `<option value="${c}">${c} MWh</option>`).join('');
        } else if (['ELEC_3', 'ELEC_6', 'ELEC_9', 'ELEC_12', 'PRIMEO_ELEC_6', 'PRIMEO_ELEC_9', 'PRIMEO_ELEC_12'].includes(type)) {
          optionsGroup.style.display = '';
        }

        if (!String(type).startsWith('IAG_')) {
          iagGroup.style.display = '';
        }
      }

      contractProvider.addEventListener('change', () => {
        contractType.dataset.provider = '';
        updateFormFields();
      });
      contractType.addEventListener('change', updateFormFields);

      function resetFormUI() {
        addContractForm.reset();
        contractDate.value = todayStr();
        contractType.dataset.provider = '';
        updateFormFields();
        clearError();
        clearEditMode();
      }

      btnClearForm.addEventListener('click', resetFormUI);
      btnCancelEdit.addEventListener('click', resetFormUI);

      addContractForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearError();

        const date = contractDate.value.trim();
        const name = contractName.value.trim().toUpperCase();
        const reference = contractRef.value.trim();
        const provider = contractProvider.value;
        const type = contractType.value;
        const iagTypeSelected = contractIagType.value;
        const iagReferenceInput = contractIagRef.value.trim();

        if (!date || !name || !reference || !provider || !type) {
          showError('Tous les champs obligatoires (*) doivent √™tre remplis.');
          return;
        }

        if (isDuplicateReference(reference, editingId)) {
          const ok = confirm('‚ö†Ô∏è Doublon d√©tect√© : cette r√©f√©rence existe d√©j√†. Continuer quand m√™me ?');
          if (!ok) return;
        }

        const base = {
          id: editingId || (Date.now() + '_' + Math.random().toString(36).substr(2, 9)),
          date,
          name,
          reference,
          provider,
          type,
          power: null,
          conso: null,
          axa: false,
          digitalisation: false,
          iagType: null,
          iagReference: null
        };

        if (type === 'DUAL') {
          base.power = contractPower.value;
          base.conso = contractConso.value;
          if (!base.power || !base.conso) {
            showError('Veuillez s√©lectionner la puissance et la consommation.');
            return;
          }
          base.axa = contractAxa.checked;
          base.digitalisation = contractDigi.checked;
        } else if (['ELEC_3', 'ELEC_6', 'ELEC_9', 'ELEC_12', 'PRIMEO_ELEC_6', 'PRIMEO_ELEC_9', 'PRIMEO_ELEC_12'].includes(type)) {
          base.axa = contractAxa.checked;
          base.digitalisation = contractDigi.checked;
        }

        if (!String(type).startsWith('IAG_') && iagTypeSelected && !iagReferenceInput) {
          showError('Veuillez saisir la r√©f√©rence IAG.');
          return;
        }

        if (!String(type).startsWith('IAG_') && iagTypeSelected) {
          base.iagType = iagTypeSelected;
          base.iagReference = iagReferenceInput ? iagReferenceInput : null;
        }

        if (String(type).startsWith('IAG_')) {
          base.provider = 'PLENITUDE';
        }

        try {
          await saveContract(base);

          const existingIdx = contracts.findIndex(c => c.id === base.id);
          if (existingIdx >= 0) {
            contracts[existingIdx] = base;
            showToast('‚úÖ Contrat modifi√©', 'success');
          } else {
            contracts.push(base);
            showToast('‚úÖ Contrat ajout√© avec succ√®s', 'success');
          }

          contracts.sort((a, b) => b.date.localeCompare(a.date));
          resetFormUI();
          renderAll();
        } catch (err) {
          showError('Erreur lors de l\'enregistrement : ' + err.message);
        }
      });

      // ========== Rendering ==========
      function renderContractItem(contract) {
        const div = document.createElement('div');
        div.className = 'list-item';

        const content = document.createElement('div');
        content.className = 'list-item-content';

        const title = document.createElement('div');
        title.className = 'list-item-title';
        title.textContent = contract.name;

        const meta = document.createElement('div');
        meta.className = 'list-item-meta';

        let metaText = `üìÖ ${formatDate(contract.date)} ‚Ä¢ üîñ ${contract.reference} ‚Ä¢ `;
        metaText += `${contractTypeLabel(contract)}`;

        if (contract.axa) metaText += ' ‚Ä¢ AXA';
        if (contract.digitalisation) metaText += ' ‚Ä¢ Digi';
        if (contract.iagType) metaText += ` ‚Ä¢ IAG ${contract.iagType}`;
        if (contract.iagReference) metaText += ` ‚Ä¢ Ref IAG ${contract.iagReference}`;

        meta.textContent = metaText;

        content.appendChild(title);
        content.appendChild(meta);

        const actions = document.createElement('div');
        actions.className = 'list-item-actions';

        const badge = document.createElement('span');
        badge.className = `badge badge-${String(contract.provider).toLowerCase()}`;
        badge.textContent = contract.provider;

        const amount = document.createElement('div');
        amount.className = 'amount';
        amount.textContent = formatEuro(calculateAmount(contract));

        const editBtn = document.createElement('button');
        editBtn.className = 'btn-sm btn-ghost';
        editBtn.textContent = '‚úèÔ∏è';
        editBtn.title = 'Modifier';
        editBtn.onclick = () => {
          setEditMode(contract.id);
          fillFormFromContract(contract);
          showToast('Mode √©dition activ√©', 'info');
          if (currentTab !== 'contrats') {
            document.querySelector('.tab-btn[data-tab="contrats"]').click();
          }
          window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-sm btn-danger';
        deleteBtn.textContent = 'üóëÔ∏è';
        deleteBtn.title = 'Supprimer';
        deleteBtn.onclick = async () => {
          if (confirm(`Supprimer le contrat ${contract.name} ?`)) {
            await deleteContract(contract.id);
            contracts = contracts.filter(c => c.id !== contract.id);
            if (editingId === contract.id) resetFormUI();
            showToast('Contrat supprim√©', 'warning');
            renderAll();
          }
        };

        actions.appendChild(badge);
        actions.appendChild(amount);
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);

        div.appendChild(content);
        div.appendChild(actions);

        return div;
      }

      function renderContractsList() {
        const filters = {
          search: searchName.value,
          provider: filterProvider.value,
          date: filterDate.value
        };

        const filtered = filterContracts(contracts, filters);

        if (filtered.length === 0) {
          contractsList.style.display = 'none';
          contractsEmpty.style.display = '';
          return;
        }

        contractsList.style.display = '';
        contractsEmpty.style.display = 'none';
        contractsList.innerHTML = '';

        filtered.forEach(c => {
          contractsList.appendChild(renderContractItem(c));
        });
      }

      function renderDay() {
        const date = dayDate.value;
        const dayContracts = contracts.filter(c => c.date === date);
        const stats = computeStats(dayContracts);

        dayKpis.innerHTML = `
          <div class="kpi"><div class="kpi-label">Total contrats</div><div class="kpi-value">${stats.total}</div></div>
          <div class="kpi"><div class="kpi-label">√ânergie</div><div class="kpi-value">${stats.energy}</div></div>
          <div class="kpi"><div class="kpi-label">IAG</div><div class="kpi-value">${stats.iag}</div></div>
          <div class="kpi"><div class="kpi-label">‚Ç¨ √ânergie</div><div class="kpi-value">${formatEuro(stats.energyAmount)}</div></div>
          <div class="kpi"><div class="kpi-label">‚Ç¨ IAG</div><div class="kpi-value">${formatEuro(stats.iagAmount)}</div><div class="kpi-sub">Tarif: ${formatEuro(getIAGTarif(stats.iag))}</div></div>
          <div class="kpi"><div class="kpi-label">‚Ç¨ Total</div><div class="kpi-value">${formatEuro(stats.totalAmount)}</div></div>
        `;

        dayNote.textContent = `Date analys√©e : ${formatDate(date)}`;

        if (dayContracts.length === 0) {
          dayContractsList.style.display = 'none';
          dayContractsEmpty.style.display = '';
          return;
        }

        dayContractsList.style.display = '';
        dayContractsEmpty.style.display = 'none';
        dayContractsList.innerHTML = '';
        dayContracts.forEach(c => dayContractsList.appendChild(renderContractItem(c)));
      }

      function renderWeek() {
        const date = weekDate.value;
        const week = getWeekRange(date);
        const weekContracts = getContractsByPeriod(contracts, week.start, week.end);
        const stats = computeStats(weekContracts);

        weekRange.textContent = `${formatDate(week.start)} ‚Üí ${formatDate(week.end)}`;
        weekNumber.textContent = `Semaine ${week.week}`;

        weekKpis.innerHTML = `
          <div class="kpi"><div class="kpi-label">Total contrats</div><div class="kpi-value">${stats.total}</div></div>
          <div class="kpi"><div class="kpi-label">√ânergie</div><div class="kpi-value">${stats.energy}</div></div>
          <div class="kpi"><div class="kpi-label">IAG</div><div class="kpi-value">${stats.iag}</div></div>
          <div class="kpi"><div class="kpi-label">‚Ç¨ √ânergie</div><div class="kpi-value">${formatEuro(stats.energyAmount)}</div></div>
          <div class="kpi"><div class="kpi-label">‚Ç¨ IAG</div><div class="kpi-value">${formatEuro(stats.iagAmount)}</div><div class="kpi-sub">Tarif: ${formatEuro(getIAGTarif(stats.iag))}</div></div>
          <div class="kpi"><div class="kpi-label">‚Ç¨ Total</div><div class="kpi-value">${formatEuro(stats.totalAmount)}</div></div>
        `;

        weekStats.innerHTML = '';
        Object.entries(stats.byType).sort((a,b) => b[1]-a[1]).forEach(([type, count]) => {
          const bar = document.createElement('div');
          bar.className = 'stat-bar';
          const pct = stats.total > 0 ? (count / stats.total * 100) : 0;
          bar.innerHTML = `
            <div class="stat-bar-header"><div class="stat-bar-title">${type.replace(/_/g,' ')}</div><div class="stat-bar-value">${count}</div></div>
            <div class="stat-bar-progress"><div class="stat-bar-fill" style="width:${pct}%"></div></div>
          `;
          weekStats.appendChild(bar);
        });

        weekContractsList.innerHTML = '';
        if (weekContracts.length === 0) {
          weekContractsList.style.display = 'none';
          weekContractsEmpty.style.display = '';
          return;
        }
        weekContractsList.style.display = '';
        weekContractsEmpty.style.display = 'none';
        weekContracts.forEach(c => weekContractsList.appendChild(renderContractItem(c)));
      }

      function renderMonth() {
        const date = monthDate.value;
        const monthStr = date.slice(0,7);
        const monthContracts = contracts.filter(c => c.date.startsWith(monthStr));
        const stats = computeStats(monthContracts);

        monthLabel.textContent = getMonthLabel(date);

        monthKpis.innerHTML = `
          <div class="kpi"><div class="kpi-label">Total contrats</div><div class="kpi-value">${stats.total}</div></div>
          <div class="kpi"><div class="kpi-label">√ânergie</div><div class="kpi-value">${stats.energy}</div></div>
          <div class="kpi"><div class="kpi-label">IAG</div><div class="kpi-value">${stats.iag}</div></div>
          <div class="kpi"><div class="kpi-label">% IAG</div><div class="kpi-value">${stats.total > 0 ? ((stats.iag / stats.total)*100).toFixed(1):0}%</div></div>
          <div class="kpi"><div class="kpi-label">‚Ç¨ √ânergie</div><div class="kpi-value">${formatEuro(stats.energyAmount)}</div></div>
          <div class="kpi"><div class="kpi-label">‚Ç¨ IAG</div><div class="kpi-value">${formatEuro(stats.iagAmount)}</div><div class="kpi-sub">Tarif: ${formatEuro(getIAGTarif(stats.iag))}</div></div>
          <div class="kpi"><div class="kpi-label">‚Ç¨ Total</div><div class="kpi-value">${formatEuro(stats.totalAmount)}</div></div>
          <div class="kpi"><div class="kpi-label">Tarif IAG</div><div class="kpi-value">${formatEuro(getIAGTarif(stats.iag))}</div><div class="kpi-sub">Par IAG</div></div>
        `;

        monthStats.innerHTML = '';
        Object.entries(stats.byType).sort((a,b) => b[1]-a[1]).forEach(([type, count]) => {
          const bar = document.createElement('div');
          bar.className = 'stat-bar';
          const pct = stats.total > 0 ? (count / stats.total * 100) : 0;
          bar.innerHTML = `
            <div class="stat-bar-header"><div class="stat-bar-title">${type.replace(/_/g,' ')}</div><div class="stat-bar-value">${count}</div></div>
            <div class="stat-bar-progress"><div class="stat-bar-fill" style="width:${pct}%"></div></div>
          `;
          monthStats.appendChild(bar);
        });

        const goal = parseInt(monthlyGoal.value) || 0;
        if (goal > 0) {
          const pct = Math.min(100, (stats.total / goal) * 100);
          goalProgress.innerHTML = `
            <div class="stat-bar">
              <div class="stat-bar-header"><div class="stat-bar-title">Progression objectif</div><div class="stat-bar-value">${stats.total} / ${goal}</div></div>
              <div class="stat-bar-progress"><div class="stat-bar-fill" style="width:${pct}%"></div></div>
            </div>
            <p style="margin-top:12px; font-size:13px; color:var(--muted);">${pct.toFixed(1)}% de l'objectif atteint</p>
          `;
        } else {
          goalProgress.innerHTML = '<p style="color:var(--muted); font-size:13px;">D√©finissez un objectif mensuel ci-dessus.</p>';
        }
      }

      function renderStats() {
        const stats = computeStats(contracts);

        globalKpis.innerHTML = `
          <div class="kpi"><div class="kpi-label">Total contrats</div><div class="kpi-value">${stats.total}</div></div>
          <div class="kpi"><div class="kpi-label">√ânergie</div><div class="kpi-value">${stats.energy}</div></div>
          <div class="kpi"><div class="kpi-label">IAG</div><div class="kpi-value">${stats.iag}</div></div>
          <div class="kpi"><div class="kpi-label">‚Ç¨ √ânergie</div><div class="kpi-value">${formatEuro(stats.energyAmount)}</div></div>
          <div class="kpi"><div class="kpi-label">‚Ç¨ IAG</div><div class="kpi-value">${formatEuro(stats.iagAmount)}</div></div>
          <div class="kpi"><div class="kpi-label">‚Ç¨ Total</div><div class="kpi-value">${formatEuro(stats.totalAmount)}</div></div>
        `;

        const byDay = {};
        const byMonth = {};
        contracts.forEach(c => {
          byDay[c.date] = (byDay[c.date] || 0) + 1;
          const month = c.date.slice(0,7);
          byMonth[month] = (byMonth[month] || 0) + 1;
        });

        const bestDay = Object.entries(byDay).sort((a,b)=>b[1]-a[1])[0] || ['--',0];
        const bestMonth = Object.entries(byMonth).sort((a,b)=>b[1]-a[1])[0] || ['--',0];

        recordsKpis.innerHTML = `
          <div class="kpi"><div class="kpi-label">Meilleur jour</div><div class="kpi-value">${bestDay[1]}</div><div class="kpi-sub">${bestDay[0] !== '--' ? formatDate(bestDay[0]) : '--'}</div></div>
          <div class="kpi"><div class="kpi-label">Meilleur mois</div><div class="kpi-value">${bestMonth[1]}</div><div class="kpi-sub">${bestMonth[0] !== '--' ? getMonthLabel(bestMonth[0] + '-01') : '--'}</div></div>
        `;

        globalStats.innerHTML = '';
        Object.entries(stats.byType).sort((a,b)=>b[1]-a[1]).forEach(([type, count]) => {
          const bar = document.createElement('div');
          bar.className = 'stat-bar';
          const pct = stats.total > 0 ? (count / stats.total * 100) : 0;
          bar.innerHTML = `
            <div class="stat-bar-header"><div class="stat-bar-title">${type.replace(/_/g,' ')}</div><div class="stat-bar-value">${count}</div></div>
            <div class="stat-bar-progress"><div class="stat-bar-fill" style="width:${pct}%"></div></div>
          `;
          globalStats.appendChild(bar);
        });
      }

      function renderAll() {
        renderContractsList();
        if (currentTab === 'jour') renderDay();
        if (currentTab === 'semaine') renderWeek();
        if (currentTab === 'mois') renderMonth();
        if (currentTab === 'stats') renderStats();
      }

      // ========== Tabs ==========
      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          tabBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          $(`#tab-${tab}`).classList.add('active');
          currentTab = tab;
          renderAll();
        });
      });

      // ========== Filters ==========
      searchName.addEventListener('input', renderContractsList);
      filterProvider.addEventListener('change', renderContractsList);
      filterDate.addEventListener('change', renderContractsList);
      dayDate.addEventListener('change', renderDay);
      weekDate.addEventListener('change', renderWeek);
      monthDate.addEventListener('change', renderMonth);

      monthlyGoal.addEventListener('change', () => {
        const val = parseInt(monthlyGoal.value) || 0;
        localStorage.setItem(STORAGE_KEYS.goal, val.toString());
        renderMonth();
      });

      // ========== Export handlers ==========
      btnGenerateWeek.addEventListener('click', () => {
        const d = exportWeekDate.value || todayStr();
        const text = buildWeekExportText(d);
        weekExportPreview.textContent = text;
        showToast('Export semaine g√©n√©r√©', 'success');
      });

      btnGenerateWeekCompact.addEventListener('click', () => {
        const d = exportWeekDate.value || todayStr();
        const text = buildWeekExportCompactText(d);
        weekExportPreview.textContent = text;
        showToast('R√©cap semaine g√©n√©r√©', 'success');
      });

      btnGenerateMonth.addEventListener('click', () => {
        const d = exportMonthDate.value || todayStr();
        const text = buildMonthExportText(d);
        monthExportPreview.textContent = text;
        showToast('Export mois g√©n√©r√©', 'success');
      });

      btnGenerateMonthCompact.addEventListener('click', () => {
        const d = exportMonthDate.value || todayStr();
        const text = buildMonthExportCompactText(d);
        monthExportPreview.textContent = text;
        showToast('R√©cap mois g√©n√©r√©', 'success');
      });

      btnCopyWeek.addEventListener('click', () => {
        const text = weekExportPreview.textContent || '';
        if (!text.trim()) { showToast('G√©n√®re d\'abord un export semaine', 'warning'); return; }
        copyToClipboard(text);
      });

      btnCopyMonth.addEventListener('click', () => {
        const text = monthExportPreview.textContent || '';
        if (!text.trim()) { showToast('G√©n√®re d\'abord un export mois', 'warning'); return; }
        copyToClipboard(text);
      });

      function downloadText(filename, text, mime = 'text/plain') {
        const blob = new Blob([text], { type: `${mime};charset=utf-8` });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      }

      btnExportJSON.addEventListener('click', () => {
        const payload = {
          version: 1,
          exportedAt: new Date().toISOString(),
          contracts,
          goal: parseInt(monthlyGoal.value) || 0
        };
        downloadText(`remuneration_backup_${todayStr()}.json`, JSON.stringify(payload, null, 2), 'application/json');
        localStorage.setItem(STORAGE_KEYS.lastBackup, new Date().toISOString());
        showToast('Backup JSON t√©l√©charg√©', 'success');
      });

      btnExportCSV.addEventListener('click', () => {
        const rows = [
          ['id','date','name','reference','provider','type','power','conso','axa','digitalisation','iagType','iagReference','amount']
        ];
        contracts.forEach(c => {
          rows.push([
            c.id,
            c.date,
            c.name,
            c.reference,
            c.provider,
            c.type,
            c.power ?? '',
            c.conso ?? '',
            c.axa ? 1 : 0,
            c.digitalisation ? 1 : 0,
            c.iagType ?? '',
            c.iagReference ?? '',
            calculateAmount(c)
          ]);
        });
        downloadText(`remuneration_contracts_${todayStr()}.csv`, toCSV(rows), 'text/csv');
        showToast('CSV t√©l√©charg√©', 'success');
      });

      btnImportJSON.addEventListener('click', () => {
        importFile.value = '';
        importFile.click();
      });

      importFile.addEventListener('change', async () => {
        const file = importFile.files && importFile.files[0];
        if (!file) return;
        try {
          const txt = await file.text();
          const data = JSON.parse(txt);
          const importedContracts = sanitizeContracts(data.contracts || data);
          await bulkReplaceContracts(importedContracts);
          contracts = importedContracts;
          contracts.sort((a,b)=>b.date.localeCompare(a.date));
          if (data.goal !== undefined) {
            monthlyGoal.value = data.goal;
            localStorage.setItem(STORAGE_KEYS.goal, String(data.goal));
          }
          resetFormUI();
          renderAll();
          showToast('Import JSON termin√©', 'success');
        } catch (err) {
          showToast('Import JSON √©chou√©: ' + err.message, 'error');
        }
      });

      btnClearAll.addEventListener('click', async () => {
        if (!confirm('Tout effacer ? Cette action est irr√©versible.')) return;
        await clearAllContracts();
        contracts = [];
        resetFormUI();
        renderAll();
        showToast('Toutes les donn√©es ont √©t√© effac√©es', 'warning');
      });

      // ========== Theme ==========
      themeToggle.addEventListener('change', () => {
        const theme = themeToggle.value;
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem(STORAGE_KEYS.theme, theme);
        showToast('Th√®me appliqu√©', 'success');
      });

      // ========== Init ==========
      async function init() {
        const today = todayStr();
        currentDateEl.textContent = formatDate(today);

        contractDate.value = today;
        dayDate.value = today;
        weekDate.value = today;
        monthDate.value = today;
        exportWeekDate.value = today;
        exportMonthDate.value = today;

        const savedTheme = localStorage.getItem(STORAGE_KEYS.theme) || 'auto';
        themeToggle.value = savedTheme;
        document.documentElement.setAttribute('data-theme', savedTheme);

        const savedGoal = localStorage.getItem(STORAGE_KEYS.goal);
        if (savedGoal) monthlyGoal.value = savedGoal;

        try {
          contracts = sanitizeContracts(await loadContracts());
          contracts.sort((a, b) => b.date.localeCompare(a.date));
        } catch (err) {
          console.error('Error loading contracts:', err);
          contracts = [];
        }

        updateFormFields();
        renderAll();

        showToast('‚úÖ Application charg√©e', 'success');
      }

      init();
    })();
  </script>
</body>
</html>
